/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model where users can only access their own data,
 * with public read access to the goals and bills collections.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /goals/{goalId}: Stores financial and personal goals. Each goal has an `ownerId` field.
 * - /bills/{billId}: Stores recurring and one-time bills. Each bill has an `ownerId` field.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user documents.
 * - Users can create goals and bills, but the `ownerId` must match their UID.
 * - Goals and bills are readable by anyone, but only the owner can modify or delete them.
 * - Listing of user documents is denied to prevent enumeration.
 *
 * Denormalization for Authorization:
 * - The `goal` and `bill` entities include an `ownerId` field, denormalizing the user relationship
 *   directly into the document. This is crucial for efficient authorization checks without requiring
 *   additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with matching UID can create their profile.
     * @allow (get) - Authenticated user can read their own profile.
     * @allow (update) - Authenticated user can update their own profile.
     * @allow (delete) - Authenticated user can delete their own profile.
     * @deny (list) - Listing all user documents is prohibited.
     * @deny (create) - Unauthenticated user cannot create a profile.
     * @deny (update) - Authenticated user cannot update another user's profile.
     * @deny (delete) - Authenticated user cannot delete another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to the goals collection.
     * @path /goals/{goalId}
     * @allow (get) - Any user can read a goal.
     * @allow (list) - Any user can list goals.
     * @allow (create) - Authenticated user can create a goal with a matching ownerId.
     * @allow (update) - Only the owner can update a goal.
     * @allow (delete) - Only the owner can delete a goal.
     * @deny (create) - Authenticated user cannot create a goal with a mismatched ownerId.
     * @deny (update) - Unauthenticated user cannot update a goal.
     * @deny (delete) - Unauthenticated user cannot delete a goal.
     * @principle Allows public read access with owner-only writes, enforcing ownership during create.
     */
    match /goals/{goalId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to the bills collection.
     * @path /bills/{billId}
     * @allow (get) - Any user can read a bill.
     * @allow (list) - Any user can list bills.
     * @allow (create) - Authenticated user can create a bill with a matching ownerId.
     * @allow (update) - Only the owner can update a bill.
     * @allow (delete) - Only the owner can delete a bill.
     * @deny (create) - Authenticated user cannot create a bill with a mismatched ownerId.
     * @deny (update) - Unauthenticated user cannot update a bill.
     * @deny (delete) - Unauthenticated user cannot delete a bill.
     * @principle Allows public read access with owner-only writes, enforcing ownership during create.
     */
    match /bills/{billId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isSignedIn() && isOwner(userId) && resource != null;
  }
}