rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /vault/{userId}/{docId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        firestore.get(/databases/(default)/documents/documents/$(docId)).data.shareSubjects[request.auth.uid] != null
      );

      allow write: if request.auth != null &&
        request.auth.uid == userId &&
        request.resource.size < 25 * 1024 * 1024 &&
        request.resource.contentType.matches('application/pdf|image/.*') &&
        (
          request.resource.metadata.encrypted == 'true' &&
          request.resource.metadata.algorithm == 'AES-GCM'
          || request.resource.metadata.encrypted == null
        );
    }
  }
}
